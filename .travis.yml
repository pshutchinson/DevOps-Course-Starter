env:
  global:
  - FLASK_APP=todo_app/app
  - FLASK_ENV=development
  - DOCKER_USERNAME=pshutchinson
  - MONGO_CLUSTER=cluster0.duj0p.mongodb.net
  - MONGO_DB=test
  - MONGO_USERNAME=admin
  - secure: QzzxBZuczObJ5X6RVRCOQ4JaSdcoo/0krxLMoRTm5+bNSko1eoYHp+PpSDuENhuvOPfYc6nquYcK4EG5juGtaXoLeYeZ5z35j85SL+26xbDAh9JMZhb1j0Ai5MdVWXkwKfsWFb56GTgsFOykmWqvhYavWj57SRkMoHxYeIkneHtYyU2mlOREPFGBM97SlTUUEkGuQ4QNN8VOOgKxopM8x7UD7SrAwVPibrHxoWlIBvC1gEcBWlfmiroE9xiFpFIg3N6Atrf28ajnwaHU6pUcZrXpskTUa02NLE6RbXUtvlV8xe5+SK+RcZkyq4YGpnyD9VONOgH2W35XsIhggm15mjFi53tY4Nnx3QwyopMcHd7p1PRx/rlcTFUZNpkRLSM0pjCE9imKEe98JK90pAYmaUKgQt0lfDF2vuxUavbFIZxJLQRasEbzD778fQoMibDhd4FmyBqsyfR389L/lH5bj7yejtRnfj4A7MQVvX/i8AE18Desvlqmuyug/vhFI4eDLIp6YdQvC4n3MLupifq96vCFcr4j9KReO+nPyMk7lhX9oGlP7bKJJOnqbJRLOUs1PsmJlHUCoxKlV83Fxj81Lgp4PpqiGmlqOkkkq++pzVDhb18gwZSGabto+pOeQzXDWsKz/ay1CG8AK7m9fXDp2IPAfUEXaCYyCa9/el1Ewtg=
  - secure: off3vGvFxgajHVk3XYEuGlym5AN/bebl88lA49I3n8Z8IL5VxOtB4wxRmfx0JH5QVZopm4wzTR1JN86SjWBuCWnMNhK03TME09rvnWM6C29LKVijTU6GC0L+/gtPHtujt+Mcs+VHsBEJacHvVJVkAHHz+F8vUCqZmf23p/GG5wWAdSI/jS09zbEOS9KLz5rmtDt2UOuhMxfzvvw8Kqbo7WwoGXcuwqjSiZPa5Esuf2dYkPyrrPLUgaK/8byL2CDvUTA5NIcySNLkLhJ/ccc3zskbEj8DF95Zu/3MVhJmgUEn6U93V62pK+aFpNWYpVeHdi22yTDIr/mXuC7afXdJJWSAiZhTAK9dS6BvrAHzEoaiOfNBvFxBpZZI+04tjoLzWQqUNtUpcGTeTj6svdaQyT9eIUA5+ZCHJqujgFxYj7MVoNjzz4ehtSF/vndfpHV+Y8z9CcASr4J10BjJNHRvrrFV+v2JJEDpSlPA0F0cSWzfLdy4Scu2TuPYu2pqyluTFmQ3hclYfd8D7wRLJ+nedb0lo2xybxCubKfleAGAw7zALbf/rwQf9BzF7xqkm541NsFAYr8mPTXPnjfBvsPGEXigahB3xzLQjLpoLYEdCx78OxqkmuilvDhFsCYJC+G42Hc6vb16YT89Z0GjVlwCNF7yjS2dBlHFSCh6SovCSzA=
  - secure: jp9Q3Jrc/J4S92GxXR0PYej0w3dqH7yTKTED5Un6KWGq4JRzPN4snhO0ynYjRKeR3hzeQ8zK+kJUFnFBedqYXgYNWhZ2oEGX3j6OQyC9KAwH2Pjagjp5WHjJhsRkCZwxwRpwjZ02mnHrbKsl78+41Gc28/BjkyhZxaYwYiiuE5bYLzxGtcar8Cnuu2l4Ls4DunrDvQ2rS9Ajfkn6wUm7LP4n6hilLOGzVXk78nol6DmpudQCmuNVJ1tgKkC7WoQ1InMLwd3BKiybR1vtMbpv4W02GS7AiGn/62j7NesrX7T/5khDW1JlcB83+cAWvzKpXoAi+0Ufk1nnFooqa4bfWGRo7iheIb7Igy7Z0cI+M0Fds2Th1yiUYDTJbqvcCSfn52+KKYbgRFa1P5HqdNkgKpsKoeW7T4vfv9T6OLfL5Ezswvzs5X1l5LG/ee4hDo23pSFuWf/oDlQd6AWYXs/h+WZF43PlL3q1wp4uyKUjwVD3XyPI6D9XF6cmFNYQSHymYZsiCX+Uko11K1oI2PmcisWP0Ep0Mt1MyPGPYy8kdK3msCCGwPune5GRLucp2ILiAv5mv2sK4gd4OqSYgIyT2uu8+7fIx7tg3g4fTv6AOD4M40ZAGQhRYwvD+IAfEHlXk4sw2vszJpcBXFcLciw13XC2Jkp4ApF68EXwL4IZpwo=
  - secure: B0WQnN6dImOotOTMBg3dGxCsjAo8EA+14KOBkk3tTU9PM1+mCiyP4BCf7OYAVh/0wKDTkPOT4+lOGinoy7kScPwogt2hAZqE3HpvLZfJK+oNZK3laB3m0lAe4ZokVpt78xdppL6T3WPcgC5w0yUN7sgSHe/7w6rDUJOR23/TMNWDppYlVSjb+EBZiHluQbWfXIY6DR2MYGAsVeWceW9VCOEkS45T8IqTPKe2GDdZQ5DpekPwgvH999VioY8kCE+TjOilHBV8jnKjqsIbx/vUy6CuMhRrsm7ss7KmxtynZbFef+K6royzQLATSkjT5SengPLgtAcz343JX4U2qhxT2dDbkpX9Bz8lqk+UkEeEVqbzTM0Q+bBMbvwsUggCWiZcX/zh/PEE9GtOWjPLfeaTHi6sG22TrML6X+8wRO5OaMgjFnOlH7uj3gKIuxdRkNbgQZ7poP4/sLqO12d0KMbKDavLuR7hOs8xSydKVroK82ig7dx6iUSIw18h4XkQNSZ80X91Myi2SMeWjZ/SfpHuE8+wrBMB+CaXB0p1RxeTEcr/7mQ9G6U30eMkKJAlnl7lpb1smI8ByUCtZu1q23tuKjKkVN4wHSNERVXXTzyXoku2cq14p79+xOF+T1Ogb9YdAQtGLrXnOPwMHlhI2xWZMrTFgogk79Y0Y2qR2aun/z0=
  - secure: gLBjXyAHpbFB8W6WLS6JOkM2mbp/ig01UMDqFWcJe0xx9t6eHiQ5RWA9Q3RAhv/9vfPMjYwmHHEKe+4D4uGuwK2iUOTHtXjJzX2qRIV9SHSIf/UNatFYpYeoZoYvu9Rx3/d6Ko1yW7ra9AMQd9nDSGXedJQjyP7SDEyJcVngu/2zAW3itVM93eMQbJJckyPBPU08HvyD3EbhXX6/HOxMvBe1/8cb1kmSgZVwmf9ljXlB4vNIXxrHRIIwlhYAbhYiNC/k6L4h6FvHSnRwHRLOohPqMZc3gOYZUDhIppYOBgt/IBL3IwLucWCFhJr5i9FsZ05XPagDznbpBfm0JV0D/dM1zMMF9Wt26lOb65+hn7xZTOrMj3OworY9iOuoOysSB0nV9WIf4oS7MjSbW+W+Q6J6ltD1ATTtRRucB96U76zBk+2mSPo+TV5EJmeEFjnt9/iFHRcKDaHEKDahAaGnx9+yNvyHv39EslqvLePSEm1GVZmYIE6IOkyIBRg7pTCesg0kPnF0wN/BzCkQgTmGF2+04JGG7yZCPb7tXXiaGDcThZLOGxiZmacI8wa8lAEpD1IcvLA6Hi0/pBeTMownVWLbUgmlsHuC/G0jhu++8w6Mkb08ig3hCrZGZeGM0vx5fdTRG2aQ7gck+wGJMCjKOnsjYJjqFq8Fui0YKInppAs=
  - secure: d+Vix0H5X9QMHpu0Ip+tQTNt13itXpeLjmPO+Ur8xWbHBhGjztxS/fySnlGEla9i/II6NqB2Vd6Je5xwV/0VWKlE5mqmVBhiYSzRe0suo1DYkvOV9Jlm8pXXZ/NUcgnKNdkZT0WwLymdfFgt67r0mjxYKrPBC9nBpK89OLg2B61iHXeJK5W4F3pTdh5dwgaHXCcDGbKUan3a7r/60kOuc7DYdEphl8W6KAfF6hInT3JwTNXHE07OCF/xU+e9e4ox59n5YHBtURg8NCBbTwaHhuB59UfxAGekfaxTZxSlo6U0T1ha0gi4KtPxoP6FZQzTiAt/8BBeTuL2pv2702biK6mJVdtd2J0X/4KZTUnkSFJBNDshVda0ZpcgAHDw6oUIqYF0m5EZTcSMR0MWJOjgZL9U0Nas/XYSTtgf3N1Y7gtPKRoc2SgB3hV+XCOhQlE0DiZp87JT2vTMJc8gphgtp8jGIOPVF20U1O2gfcTJ7CUHAkJwb5TaMUNkObsfvlBXe1Wfh0Buzlx8Cs7TlnPrmn3xawb2T6r3+YPri9hz9xBkk8gZY5QSWknI6dfdOPQidw9UFa9tyoICsm4u2SK3fBEtnT94pogS0D1oaOjCl60cysmhNtkNvq7t1HmNaFy/WRBBQGW0CV5unRXrnoSCN3G2GtWa3fbd0W70eZiJ4N4=
  - secure: ntZZWhRfalZKe/rtwf3stbkMS7z5biHSQ+NUyXP1wlJ0+X20NOKtO/HWZkzpzY9eY7ugW7CrOqi8S8slBoPM5SBeYMIPmSOYpIQfSLm8OFcXJyddNnfiWV8kX0irhhCl0V1wdr1waiMyqunuzhMDmNm6PGUTNrrbe/3OmxEqDQZ+pI0MStM66qNMaabJDZUkvnnTG8uf2U5tKUN6Cmmqj3UqRO8bQIgpJQWCClbW92NQXepY0aswbO7MILFXa8w6pMZzqdlCfp82ASkcLy1sXJND3pFYN+B4fXCSPi6DDzKxxo3uFiBLnhWmIpNT8lt8mitK+5GwPwQTdGoCiKqr/f0L9KVfh/S1RnT8KQANp6fFgBivGzxg2PicKEi5is5qwbKdyuyLxXlzLXWG83wIOjA9PUf0XpqFEedOdvNdwiaus3fkAtIGbO3SnW2OQMIq10W7JSW1sZeB/KqtjYLZyAfh/2kAw/r5lbw2Aa1sjo0JcfEqe/zteOMN81Dsea6LctF67cJLQW6ewgV0Uti8ceh7djUFVrhV1wfU1D5SBXKh83r8XaijRyYu6GmM9cf6vlLDDMUhOCWTFx8cHE+vJmRYhUqw1m/ufiE8OBU8jbRy58u+S9NPhPqOBLQLkhlgIJbcCRl0SLA0QlPjJh9ef6A9FYNVA/Vz4KpqfE2jn74=
script:
- export TRAVIS_TAG="pshutchinson/todo_app:${TRAVIS_COMMIT}"
- docker build --target test --tag my-test-image .
- docker run my-test-image todo_app/test_ViewModel.py
- docker run my-test-image todo_app/test_app.py
- docker run -e FLASK_APP -e FLASK_ENV -e SECRET_KEY -e MONGO_CLUSTER -e MONGO_DB -e MONGO_USER -e MONGO_PWD my-test-image todo_app/e2etests
deploy:
  provider: script
  on:
    branch: master
  script: >-
    echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin &&
    docker build --target production --tag "$TRAVIS_TAG" . &&
    docker push "$TRAVIS_TAG" &&
    docker build --target production --tag pshutchinson/todo_app:latest . &&
    docker push pshutchinson/todo_app:latest &&
    docker pull pshutchinson/todo_app:latest &&
    echo $HEROKU_API_KEY | docker login --username=_ --password-stdin registry.heroku.com &&
    docker tag pshutchinson/todo_app registry.heroku.com/pshutchinson-todoapp/web &&
    docker push registry.heroku.com/pshutchinson-todoapp/web &&
    heroku container:push web --app pshutchinson-todoapp &&
    heroku container:release web --app pshutchinson-todoapp &&
    docker logout
notifications:
  email:
    on_success: never
    on_failure: always
