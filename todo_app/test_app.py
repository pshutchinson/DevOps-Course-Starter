import pytest
from todo_app import app
from dotenv import find_dotenv, load_dotenv
from unittest.mock import patch, Mock

TEST_BOARD_ID = '6006195ae74f187322fda449'

@pytest.fixture
def client():
    # Use our test integration config instead of the 'real' version
    file_path = find_dotenv('.env.test')

    load_dotenv(file_path, override=True)
    # Create the new app.
    test_app = app.create_app()
    
    with test_app.test_client() as client:
        return client

def mock_get_lists(url, params):
    response = Mock()
    if url == f'https://api.trello.com/1/members/me/boards':
        # sample_trello_lists_response should point to some test response data
        response.json.return_value = "'[{\"name\":\"Exercise-2\",\"desc\":\"\",\"descData\":null,\"closed\":false,\"dateClosed\":null,\"idOrganization\":\"6006186662fa8c2f45d90b78\",\"idEnterprise\":null,\"limits\":null,\"pinned\":null,\"shortLink\":\"BwoWDFLv\",\"powerUps\":[],\"dateLastActivity\":\"2021-02-20T22:24:43.145Z\",\"idTags\":[],\"datePluginDisable\":null,\"creationMethod\":\"automatic\",\"ixUpdate\":null,\"enterpriseOwned\":false,\"idBoardSource\":null,\"idMemberCreator\":\"6006181200fa415dcdc0bd34\",\"id\":\"6006195ae74f187322fda449\",\"starred\":false,\"url\":\"https://trello.com/b/BwoWDFLv/exercise-2\",\"prefs\":{\"permissionLevel\":\"org\",\"hideVotes\":false,\"voting\":\"disabled\",\"comments\":\"members\",\"invitations\":\"members\",\"selfJoin\":true,\"cardCovers\":true,\"isTemplate\":false,\"cardAging\":\"regular\",\"calendarFeedEnabled\":false,\"background\":\"6005634ee81d726404d39df3\",\"backgroundImage\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/original/bd8b4acda66141bfbfdd2bcba104f930/photo-1610960245237-cfab0dea6be4\",\"backgroundImageScaled\":[{\"width\":80,\"height\":100,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/80x100/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":154,\"height\":192,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/154x192/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":384,\"height\":480,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/384x480/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":768,\"height\":960,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/768x960/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":819,\"height\":1024,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/819x1024/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":1024,\"height\":1280,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/1024x1280/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":1536,\"height\":1920,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/1536x1920/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":1280,\"height\":1600,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/1280x1600/3c6a26e218ea3adedc0738033a885d02/photo-1610960245237-cfab0dea6be4.jpg\"},{\"width\":1638,\"height\":2048,\"url\":\"https://trello-backgrounds.s3.amazonaws.com/SharedBackground/original/bd8b4acda66141bfbfdd2bcba104f930/photo-1610960245237-cfab0dea6be4\"}],\"backgroundTile\":false,\"backgroundBrightness\":\"dark\",\"backgroundBottomColor\":\"#0d1310\",\"backgroundTopColor\":\"#0f140f\",\"canBePublic\":true,\"canBeEnterprise\":true,\"canBeOrg\":true,\"canBePrivate\":true,\"canInvite\":true},\"subscribed\":false,\"labelNames\":{\"green\":\"\",\"yellow\":\"\",\"orange\":\"\",\"red\":\"\",\"purple\":\"\",\"blue\":\"\",\"sky\":\"\",\"lime\":\"\",\"pink\":\"\",\"black\":\"\"},\"dateLastView\":\"2021-02-20T22:29:43.464Z\",\"shortUrl\":\"https://trello.com/b/BwoWDFLv\",\"templateGallery\":null,\"premiumFeatures\":[],\"memberships\":[{\"id\":\"6006195ae74f187322fda44d\",\"idMember\":\"6006181200fa415dcdc0bd34\",\"memberType\":\"admin\",\"unconfirmed\":false,\"deactivated\":false}]}]'"
        return response
    elif url == f'https://api.trello.com/1/boards/{TEST_BOARD_ID}/lists':
        # sample_trello_lists_response should point to some test response data
        response.json.return_value = [{'id':'6006195ae74f187322fda44a','name':'To Do','closed':False,'pos':16384,'softLimit':None,'idBoard':'6006195ae74f187322fda449','subscribed':False,'cards':[]},{'id':'6006195ae74f187322fda44b','name':'Doing','closed':False,'pos':32768,'softLimit':None,'idBoard':'6006195ae74f187322fda449','subscribed':False,'cards':[]},{'id':'6006195ae74f187322fda44c','name':'Done','closed':False,'pos':49152,'softLimit':None,'idBoard':'6006195ae74f187322fda449','subscribed':False,'cards':[{'id':'60061964b2eea06246f92ac2','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:34.391Z','desc':'Some details','descData':{'emoji':{}},'dueReminder':1440,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':1,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'Item1','pos':65535,'shortLink':'rFvpiqd3','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':True,'due':'2021-01-30T22:23:00.000Z','dueComplete':False,'start':None},'dueComplete':False,'due':'2021-01-30T22:23:00.000Z','idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/rFvpiqd3','start':None,'subscribed':False,'url':'https://trello.com/c/rFvpiqd3/1-item1','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}},{'id':'600619661a3dee57a371fe9c','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:36.644Z','desc':'','descData':None,'dueReminder':None,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':2,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'A Test Item','pos':131071,'shortLink':'wljXMT2e','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':False,'due':None,'dueComplete':False,'start':'2021-02-19T08:00:00.000Z'},'dueComplete':False,'due':None,'idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/wljXMT2e','start':'2021-02-19T08:00:00.000Z','subscribed':False,'url':'https://trello.com/c/wljXMT2e/2-item2','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}},{'id':'6006196887717852fa2694e7','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:43.145Z','desc':'','descData':None,'dueReminder':None,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':3,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'Item3','pos':196607,'shortLink':'yOij3XNe','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':False,'due':None,'dueComplete':False,'start':None},'dueComplete':False,'due':None,'idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/yOij3XNe','start':None,'subscribed':False,'url':'https://trello.com/c/yOij3XNe/3-item3','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}},{'id':'6006196aa7c99902f86f146e','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:39.146Z','desc':'','descData':None,'dueReminder':None,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':4,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'Item4','pos':262143,'shortLink':'NX3zi1Os','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':False,'due':None,'dueComplete':False,'start':None},'dueComplete':False,'due':None,'idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/NX3zi1Os','start':None,'subscribed':False,'url':'https://trello.com/c/NX3zi1Os/4-item4','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}},{'id':'600df1aca657926f22d62f64','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:30.372Z','desc':'','descData':None,'dueReminder':None,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':5,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'Item5','pos':278527,'shortLink':'Zr8Dlaax','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':False,'due':None,'dueComplete':False,'start':None},'dueComplete':False,'due':None,'idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/Zr8Dlaax','start':None,'subscribed':False,'url':'https://trello.com/c/Zr8Dlaax/5-item5','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}},{'id':'6011e66d138816466c718dd1','checkItemStates':None,'closed':False,'dateLastActivity':'2021-02-20T22:24:28.064Z','desc':'','descData':None,'dueReminder':None,'idBoard':'6006195ae74f187322fda449','idList':'6006195ae74f187322fda44c','idMembersVoted':[],'idShort':6,'idAttachmentCover':None,'idLabels':[],'manualCoverAttachment':False,'name':'Item6','pos':294911,'shortLink':'I40ufeRw','isTemplate':False,'cardRole':None,'badges':{'attachmentsByType':{'trello':{'board':0,'card':0}},'location':False,'votes':0,'viewingMemberVoted':False,'subscribed':False,'fogbugz':'','checkItems':0,'checkItemsChecked':0,'checkItemsEarliestDue':None,'comments':0,'attachments':0,'description':False,'due':None,'dueComplete':False,'start':None},'dueComplete':False,'due':None,'idChecklists':[],'idMembers':[],'labels':[],'shortUrl':'https://trello.com/c/I40ufeRw','start':None,'subscribed':False,'url':'https://trello.com/c/I40ufeRw/6-item6','cover':{'idAttachment':None,'color':None,'idUploadedBackground':None,'size':'normal','brightness':'light','idPlugin':None}}]}]
        return response
    return None

@patch('requests.get')
def test_index_page(mock_get_requests, client):
    mock_get_requests.side_effect = mock_get_lists
    response = client.get('/')
    assert 'A Test Item' in response.data.decode("utf-8") 